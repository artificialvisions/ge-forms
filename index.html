<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GE Healthcare - Generatore Moduli</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .ge-logo {
            width: 80px;
            height: 80px;
            background: #522398;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 32px;
        }

        .header-text h1 {
            color: #522398;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header-text p {
            color: #666;
            font-size: 14px;
        }

        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .upload-area {
            border: 2px dashed #522398;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: #f9f5fc;
            border-color: #6b2fb5;
        }

        .upload-area.dragover {
            background: #f0e6f7;
            border-color: #6b2fb5;
        }

        .upload-icon {
            font-size: 48px;
            color: #522398;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #333;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #999;
            font-size: 14px;
        }

        .file-input {
            display: none;
        }

        .tabs-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tabs-header {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 20px;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #ebebeb;
        }

        .tab.active {
            background: white;
            color: #522398;
            border-bottom: 3px solid #522398;
        }

        .tab-content {
            padding: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #522398;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .items-section {
            margin-top: 30px;
        }

        .items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .items-header h3 {
            color: #522398;
            font-size: 20px;
        }

        .add-item-btn {
            background: #522398;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .add-item-btn:hover {
            background: #6b2fb5;
        }

        .items-table {
            width: 100%;
            background: white;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .items-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .items-table th {
            background: #522398;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }

        .items-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .items-table tr:last-child td {
            border-bottom: none;
        }

        .items-table input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 13px;
        }

        .items-table input:focus {
            outline: none;
            border-color: #522398;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .export-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
        }

        .export-btn {
            background: #522398;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
            box-shadow: 0 2px 4px rgba(82, 35, 152, 0.3);
        }

        .export-btn:hover {
            background: #6b2fb5;
            box-shadow: 0 4px 8px rgba(82, 35, 152, 0.4);
        }

        .export-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .status-message {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #522398;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef } = React;

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const App = () => {
            const [activeTab, setActiveTab] = useState('collaudo');
            const [pickData, setPickData] = useState(null);
            const [statusMessage, setStatusMessage] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            
            const [collaudoData, setCollaudoData] = useState({
                billTo: '',
                shipTo: '',
                cigNr: '',
                systemMust: '',
                poNr: '',
                gonNr: '',
                cupNr: '',
                warrantyPeriod: '',
                warrantyText: '',
                items: []
            });

            const [trainingData, setTrainingData] = useState({
                billTo: '',
                shipTo: '',
                cigNr: '',
                systemMust: '',
                poNr: '',
                gonNr: '',
                cupNr: '',
                items: []
            });

            const fileInputRef = useRef(null);

            const extractDataFromText = (text) => {
                const data = {
                    orderNumber: '',
                    shipTo: '',
                    items: []
                };

                const orderMatch = text.match(/Order Number:\s*(\d+)/i);
                if (orderMatch) {
                    data.orderNumber = orderMatch[1];
                }

                // Estrazione SHIP TO migliorata - si ferma alla prima occorrenza di FOB
                const shipToPattern = /SHIP TO:\s*(.+?)(?=\s+FOB:)/is;
                const shipToMatch = text.match(shipToPattern);
                if (shipToMatch) {
                    // Pulisce il testo estratto
                    let shipToText = shipToMatch[1]
                        .replace(/\s+/g, ' ')  // Sostituisce spazi multipli con uno solo
                        .replace(/,\s*/g, ', ') // Sistema le virgole
                        .trim();
                    data.shipTo = shipToText;
                }

                // Parsing piÃ¹ robusto per catturare TUTTI gli item
                // Pattern 1: cerca righe con numero grid (es: "10.1") seguito da codice item
                const gridPattern = /(\d+\.\d+)\s+([A-Z0-9]+[A-Z])\s+(.+?)(?=\d+\.\d+\s+[A-Z0-9]+[A-Z]|$)/gs;
                let match;
                const potentialItems = [];
                
                while ((match = gridPattern.exec(text)) !== null) {
                    const gridNum = match[1];
                    const itemNumber = match[2];
                    const restOfLine = match[3];
                    
                    // Cerca descrizione, qty, e serial nella riga
                    const lineMatch = restOfLine.match(/^(.+?)\s+(\d+)\s+EA\s+([A-Z0-9]*)/);
                    
                    if (lineMatch) {
                        let description = lineMatch[1].trim();
                        const qty = lineMatch[2];
                        let serialNumber = lineMatch[3] || '';
                        
                        // Pulizia serial number: ignora locator del magazzino (FG, FG-3PL-US, ecc.)
                        // I serial number veri sono alfanumerici lunghi (es: LFO442142, 401996WP4)
                        // I locator sono brevi (es: FG, FG-3PL-US) o seguono pattern "FG-"
                        if (serialNumber.startsWith('FG') || serialNumber.length < 6) {
                            serialNumber = '';
                        }
                        
                        // Pulizia descrizione
                        description = description.replace(/\s+/g, ' ').trim();
                        // Rimuovi eventuali suffissi come "FG-3PL-US" dalla descrizione
                        description = description.replace(/\s*FG-3PL-US\s*$/, '').trim();
                        
                        potentialItems.push({
                            itemNumber,
                            description,
                            qty,
                            serialNumber
                        });
                    }
                }
                
                // Se il pattern grid ha trovato items, usali
                if (potentialItems.length > 0) {
                    data.items = potentialItems;
                    // Aggiungi il contatore per verifica
                    data.itemCount = potentialItems.length;
                } else {
                    // Fallback: pattern piÃ¹ semplice senza grid number
                    const simplePattern = /([A-Z]\d+[A-Z0-9]+)\s+([A-Za-z0-9\s\-+().]+?)\s+(\d+)\s+EA\s*([A-Z0-9]*)/g;
                    while ((match = simplePattern.exec(text)) !== null) {
                        const itemNumber = match[1];
                        let description = match[2].trim();
                        const qty = match[3];
                        let serialNumber = match[4] || '';
                        
                        // Ignora locator
                        if (serialNumber.startsWith('FG') || serialNumber.length < 6) {
                            serialNumber = '';
                        }
                        
                        description = description.replace(/\s+/g, ' ').trim();
                        
                        data.items.push({
                            itemNumber,
                            description,
                            qty,
                            serialNumber
                        });
                    }
                    data.itemCount = data.items.length;
                }

                return data;
            };

            const parsePDF = async (file) => {
                setIsLoading(true);
                setStatusMessage({ type: 'info', text: 'Analisi del PDF in corso...' });

                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    
                    let fullText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + '\n';
                    }

                    const extractedData = extractDataFromText(fullText);
                    
                    // Debug: mostra cosa Ã¨ stato estratto
                    console.log('Dati estratti dalla pick:', {
                        orderNumber: extractedData.orderNumber,
                        shipTo: extractedData.shipTo,
                        itemCount: extractedData.items.length
                    });
                    
                    setPickData(extractedData);
                    
                    setCollaudoData(prev => ({
                        ...prev,
                        billTo: extractedData.shipTo,
                        shipTo: extractedData.shipTo,
                        gonNr: extractedData.orderNumber,
                        items: extractedData.items
                    }));

                    setTrainingData(prev => ({
                        ...prev,
                        billTo: extractedData.shipTo,
                        shipTo: extractedData.shipTo,
                        gonNr: extractedData.orderNumber,
                        items: extractedData.items
                    }));

                    setStatusMessage({ 
                        type: 'success', 
                        text: `âœ“ PDF caricato con successo! Trovati ${extractedData.items.length} articoli dalla pick. Verifica che il numero corrisponda!` 
                    });
                } catch (error) {
                    console.error('Errore parsing PDF:', error);
                    setStatusMessage({ 
                        type: 'error', 
                        text: 'Errore durante l\'analisi del PDF. Verifica che il file sia valido.' 
                    });
                } finally {
                    setIsLoading(false);
                }
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file && file.type === 'application/pdf') {
                    parsePDF(file);
                } else {
                    setStatusMessage({ 
                        type: 'error', 
                        text: 'Per favore carica un file PDF valido.' 
                    });
                }
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.currentTarget.classList.add('dragover');
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
                
                const file = e.dataTransfer.files[0];
                if (file && file.type === 'application/pdf') {
                    parsePDF(file);
                }
            };

            const updateCollaudoField = (field, value) => {
                setCollaudoData(prev => ({ ...prev, [field]: value }));
            };

            const updateTrainingField = (field, value) => {
                setTrainingData(prev => ({ ...prev, [field]: value }));
            };

            const updateCollaudoItem = (index, field, value) => {
                setCollaudoData(prev => {
                    const newItems = [...prev.items];
                    newItems[index] = { ...newItems[index], [field]: value };
                    return { ...prev, items: newItems };
                });
            };

            const updateTrainingItem = (index, field, value) => {
                setTrainingData(prev => {
                    const newItems = [...prev.items];
                    newItems[index] = { ...newItems[index], [field]: value };
                    return { ...prev, items: newItems };
                });
            };

            const addCollaudoItem = () => {
                setCollaudoData(prev => ({
                    ...prev,
                    items: [...prev.items, { itemNumber: '', description: '', qty: '', serialNumber: '' }]
                }));
            };

            const addTrainingItem = () => {
                setTrainingData(prev => ({
                    ...prev,
                    items: [...prev.items, { itemNumber: '', description: '', qty: '', serialNumber: '' }]
                }));
            };

            const deleteCollaudoItem = (index) => {
                setCollaudoData(prev => ({
                    ...prev,
                    items: prev.items.filter((_, i) => i !== index)
                }));
            };

            const deleteTrainingItem = (index) => {
                setTrainingData(prev => ({
                    ...prev,
                    items: prev.items.filter((_, i) => i !== index)
                }));
            };

            const exportCollaudoPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Logo/Intestazione (per ora solo testo)
                doc.setFontSize(11);
                doc.setTextColor(82, 35, 152);
                doc.setFont(undefined, 'bold');
                doc.text('GE HealthCare', 15, 15);
                
                // Titolo principale
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('VERBALE DI COLLAUDO E ACCETTAZIONE DEL SISTEMA', 105, 35, { align: 'center' });
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.text('(ACCEPTANCE DOCUMENT)', 105, 42, { align: 'center' });

                // Intestatario e destinazione
                let y = 52;
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.text('Intestatario (bill to)', 15, y);
                doc.text('destinazione (ship to)', 110, y);
                
                // Box per bill to e ship to
                doc.setDrawColor(0);
                doc.setLineWidth(0.3);
                doc.rect(15, y + 2, 85, 20);
                doc.rect(110, y + 2, 85, 20);
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                const billToLines = doc.splitTextToSize(collaudoData.billTo || '', 80);
                doc.text(billToLines, 17, y + 6);
                
                const shipToLines = doc.splitTextToSize(collaudoData.shipTo || '', 80);
                doc.text(shipToLines, 112, y + 6);

                // Campi CIG, System, PO, GON
                y = 78;
                doc.setFontSize(8);
                doc.setFont(undefined, 'bold');
                doc.text('CIG nr', 15, y);
                doc.text('System in Must nr', 55, y);
                doc.text('Ordine Cliente nr (PO nr)', 110, y);
                doc.text('GON nr', 165, y);
                
                doc.setFont(undefined, 'normal');
                doc.rect(15, y + 2, 35, 6);
                doc.rect(55, y + 2, 50, 6);
                doc.rect(110, y + 2, 50, 6);
                doc.rect(165, y + 2, 30, 6);
                
                doc.text(collaudoData.cigNr || '', 17, y + 6);
                doc.text(collaudoData.systemMust || '', 57, y + 6);
                doc.text(collaudoData.poNr || '', 112, y + 6);
                doc.text(collaudoData.gonNr || '', 167, y + 6);

                // CUP
                y += 10;
                doc.setFont(undefined, 'bold');
                doc.text('CUP nr', 15, y);
                doc.setFont(undefined, 'normal');
                doc.rect(15, y + 2, 180, 6);
                doc.text(collaudoData.cupNr || '', 17, y + 6);

                // Alla presenza dei Signori
                y += 14;
                doc.setFont(undefined, 'bold');
                doc.text('Alla presenza dei Signori', 15, y);
                doc.text('per', 110, y);
                doc.text('GE MEDICAL SYSTEMS ITALIA SPA', 120, y);
                
                doc.setFontSize(7);
                doc.setFont(undefined, 'italic');
                doc.text('(people attending acceptance)', 15, y + 4);
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                for (let i = 0; i < 3; i++) {
                    doc.text('per', 110, y + 8 + (i * 4));
                }
                
                doc.text('per', 110, y + 20);
                doc.setFont(undefined, 'bold');
                doc.text('CLIENTE CUSTOMER', 120, y + 20);
                
                doc.setFont(undefined, 'normal');
                doc.text('per', 110, y + 24);
                doc.text('per', 110, y + 28);

                // Si Ã¨ proceduto al Collaudo
                y += 36;
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.text('Si Ã¨ proceduto al Collaudo', 15, y);
                doc.text('Serial Number', 165, y);
                
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.text('delle seguenti apparecchiature', 15, y + 4);
                doc.setFontSize(7);
                doc.setFont(undefined, 'italic');
                doc.text('(LIST OF ITEMS)', 15, y + 8);

                // Tabella items
                const tableData = collaudoData.items.map(item => [
                    item.itemNumber,
                    item.description,
                    item.qty,
                    item.serialNumber
                ]);

                doc.autoTable({
                    startY: y + 12,
                    head: [['Item Number', 'Description', 'Qty', 'Serial Number']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [255, 255, 255],
                        textColor: [0, 0, 0],
                        fontStyle: 'bold',
                        lineWidth: 0.3,
                        lineColor: [0, 0, 0]
                    },
                    styles: { 
                        fontSize: 7,
                        cellPadding: 2,
                        lineWidth: 0.3,
                        lineColor: [0, 0, 0]
                    },
                    columnStyles: {
                        0: { cellWidth: 30 },
                        1: { cellWidth: 90 },
                        2: { cellWidth: 15 },
                        3: { cellWidth: 40 }
                    }
                });

                // Testo legale
                let finalY = doc.lastAutoTable.finalY + 8;
                doc.setFontSize(7);
                doc.setFont(undefined, 'normal');
                doc.text('Il Cliente provvederÃ  a verificare l\'efficienza dell\'impianto di terra a monte del Sistema ed a mantenerla nel tempo.', 15, finalY);
                
                finalY += 4;
                doc.setFont(undefined, 'bold');
                doc.text('IL MATERIALE E\' RISULTATO RISPONDENTE ALLE CONDIZIONI CONTRATTUALI.', 15, finalY);
                
                finalY += 4;
                doc.text('LA SOTTOSCRIZIONE DEL PRESENTE VERBALE COSTITUISCE TITOLO VALIDO AL FINE DELLA DECORRENZA DEGLI ADEMPIMENTI', 15, finalY);
                finalY += 3;
                doc.text('CONTRATTUALI LEGATI AL COLLAUDO.', 15, finalY);

                // Allegati
                finalY += 8;
                doc.setFont(undefined, 'bold');
                doc.text('ALLEGATI:', 15, finalY);
                
                doc.rect(35, finalY - 3, 3, 3);
                doc.text('X', 36, finalY - 0.5);
                doc.setFont(undefined, 'normal');
                doc.text('DICHIARAZIONE DI CONFORMITA\'', 40, finalY);
                
                doc.rect(110, finalY - 3, 3, 3);
                doc.text('SCHEDA MISURE', 115, finalY);
                
                finalY += 5;
                doc.rect(35, finalY - 3, 3, 3);
                doc.text('ALTRE:', 40, finalY);

                // Data verbale e firme
                finalY += 8;
                doc.setFont(undefined, 'bold');
                doc.text('Data verbale:', 15, finalY);
                doc.setFontSize(6);
                doc.setFont(undefined, 'italic');
                doc.text('(ACCEPTANCE DATE)', 15, finalY + 3);
                
                doc.setFontSize(7);
                doc.setFont(undefined, 'normal');
                doc.rect(15, finalY + 5, 80, 20);
                
                doc.text('Per la Casa fornitrice', 15, finalY + 8);
                doc.setFontSize(6);
                doc.setFont(undefined, 'italic');
                doc.text('(SUPPLIER)', 15, finalY + 11);
                
                doc.setFontSize(7);
                doc.setFont(undefined, 'normal');
                doc.rect(110, finalY + 5, 85, 20);
                doc.text('Timbro e firma del Cliente', 110, finalY + 8);
                doc.setFontSize(6);
                doc.setFont(undefined, 'italic');
                doc.text('(CUSTOMER)', 110, finalY + 11);

                // Sezione Garanzia
                finalY += 28;
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                
                // Calcola altezza box in base al contenuto
                const boxHeight = collaudoData.warrantyText ? 28 : 12;
                doc.rect(15, finalY, 180, boxHeight);
                doc.text('Durata della Garanzia:', 17, finalY + 4);
                doc.setFontSize(7);
                doc.setFont(undefined, 'italic');
                doc.text('(WARRANTY PERIOD)', 17, finalY + 8);
                
                finalY += 14;
                doc.setFontSize(7);
                doc.setFont(undefined, 'normal');
                
                // Se c'Ã¨ testo personalizzato, usa quello, altrimenti usa il testo di default
                if (collaudoData.warrantyText && collaudoData.warrantyText.trim()) {
                    // Usa il testo personalizzato inserito dall'utente
                    const warrantyLines = doc.splitTextToSize(collaudoData.warrantyText, 175);
                    doc.text(warrantyLines, 17, finalY);
                    finalY += (warrantyLines.length * 4) + 2;
                } else {
                    // Testo di default
                    doc.text('Se applicabile:', 15, finalY);
                    finalY += 4;
                    doc.text(`Per le parti meccaniche ed elettriche, ${collaudoData.warrantyPeriod || '____'} mesi`, 15, finalY);
                    finalY += 4;
                    doc.text('a scalare', 15, finalY);
                    finalY += 2;
                }
                
                finalY += 4;
                doc.text('Come da contratto di vendita, la garanzia decorre dalla data del presente documento', 15, finalY);

                // Footer aziendale
                finalY += 10;
                doc.setFontSize(6);
                doc.setFont(undefined, 'bold');
                doc.text('GE Medical Systems Italia S.p.A.', 15, finalY);
                finalY += 3;
                doc.setFont(undefined, 'normal');
                doc.text('SocietÃ  con socio unico, Capitale â‚¬ 5.000.000 i.v. - Sede Legale: Via Galeno 36, 20126 Milano', 15, finalY);
                finalY += 3;
                doc.text('CF e Registro Imprese Milano 93027710016 REA 1689710 P.IVA 03663500969', 15, finalY);
                finalY += 3;
                doc.text('SocietÃ  soggetta a controllo e coordinamento di General Electric Company', 15, finalY);
                finalY += 3;
                doc.text('TEL +39 02 26001111 - FAX +39 02 26001413', 15, finalY);

                doc.save(`Collaudo_${collaudoData.gonNr || 'documento'}.pdf`);
                setStatusMessage({ type: 'success', text: 'PDF Collaudo esportato con successo!' });
            };

            const exportTrainingPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Logo/Intestazione (per ora solo testo)
                doc.setFontSize(11);
                doc.setTextColor(82, 35, 152);
                doc.setFont(undefined, 'bold');
                doc.text('GE HealthCare', 15, 15);
                
                // Titolo principale (su due righe per evitare overflow)
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('ATTESTAZIONE DELL\'AVVENUTO TRAINING', 105, 32, { align: 'center' });
                doc.text('DEL PERSONALE SANITARIO', 105, 40, { align: 'center' });
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.text('(ACCEPTANCE DOCUMENT)', 105, 47, { align: 'center' });

                // Intestatario e destinazione
                let y = 55;
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.text('Intestatario (bill to)', 15, y);
                doc.text('destinazione (ship to)', 110, y);
                
                // Box per bill to e ship to
                doc.setDrawColor(0);
                doc.setLineWidth(0.3);
                doc.rect(15, y + 2, 85, 20);
                doc.rect(110, y + 2, 85, 20);
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                const billToLines = doc.splitTextToSize(trainingData.billTo || '', 80);
                doc.text(billToLines, 17, y + 6);
                
                const shipToLines = doc.splitTextToSize(trainingData.shipTo || '', 80);
                doc.text(shipToLines, 112, y + 6);

                // Campi CIG, System, PO, GON
                y = 78;
                doc.setFontSize(8);
                doc.setFont(undefined, 'bold');
                doc.text('CIG nr', 15, y);
                doc.text('System in Must nr', 55, y);
                doc.text('Ordine Cliente nr (PO nr)', 110, y);
                doc.text('GON nr', 165, y);
                
                doc.setFont(undefined, 'normal');
                doc.rect(15, y + 2, 35, 6);
                doc.rect(55, y + 2, 50, 6);
                doc.rect(110, y + 2, 50, 6);
                doc.rect(165, y + 2, 30, 6);
                
                doc.text(trainingData.cigNr || '', 17, y + 6);
                doc.text(trainingData.systemMust || '', 57, y + 6);
                doc.text(trainingData.poNr || '', 112, y + 6);
                doc.text(trainingData.gonNr || '', 167, y + 6);

                // CUP
                y += 10;
                doc.setFont(undefined, 'bold');
                doc.text('CUP nr', 15, y);
                doc.setFont(undefined, 'normal');
                doc.rect(15, y + 2, 180, 6);
                doc.text(trainingData.cupNr || '', 17, y + 6);

                // Alla presenza dei Signori
                y += 14;
                doc.setFont(undefined, 'bold');
                doc.text('Alla presenza dei Signori', 15, y);
                doc.text('per', 110, y);
                doc.text('GE MEDICAL SYSTEMS ITALIA SPA', 120, y);
                
                doc.setFontSize(7);
                doc.setFont(undefined, 'italic');
                doc.text('(people attending acceptance)', 15, y + 4);
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                for (let i = 0; i < 3; i++) {
                    doc.text('per', 110, y + 8 + (i * 4));
                }
                
                doc.text('per', 110, y + 20);
                doc.setFont(undefined, 'bold');
                doc.text('CLIENTE CUSTOMER', 120, y + 20);
                
                doc.setFont(undefined, 'normal');
                doc.text('per', 110, y + 24);
                doc.text('per', 110, y + 28);

                // Si Ã¨ proceduto al training
                y += 36;
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.text('Si Ã¨ proceduto al training', 15, y);
                doc.text('Serial Number', 165, y);
                
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.text('per le seguenti apparecchiature', 15, y + 4);
                doc.setFontSize(7);
                doc.setFont(undefined, 'italic');
                doc.text('(LIST OF ITEMS)', 15, y + 8);

                // Tabella items
                const tableData = trainingData.items.map(item => [
                    item.itemNumber,
                    item.description,
                    item.qty,
                    item.serialNumber
                ]);

                doc.autoTable({
                    startY: y + 12,
                    head: [['Item Number', 'Description', 'Qty', 'Serial Number']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [255, 255, 255],
                        textColor: [0, 0, 0],
                        fontStyle: 'bold',
                        lineWidth: 0.3,
                        lineColor: [0, 0, 0]
                    },
                    styles: { 
                        fontSize: 7,
                        cellPadding: 2,
                        lineWidth: 0.3,
                        lineColor: [0, 0, 0]
                    },
                    columnStyles: {
                        0: { cellWidth: 30 },
                        1: { cellWidth: 90 },
                        2: { cellWidth: 15 },
                        3: { cellWidth: 40 }
                    }
                });

                // Testo legale
                let finalY = doc.lastAutoTable.finalY + 8;
                doc.setFontSize(7);
                doc.setFont(undefined, 'normal');
                doc.text('Il Cliente provvederÃ  a verificare l\'efficienza dell\'impianto di terra a monte del Sistema ed a mantenerla nel tempo.', 15, finalY);
                
                finalY += 4;
                doc.setFont(undefined, 'bold');
                doc.text('IL MATERIALE E\' RISULTATO RISPONDENTE ALLE CONDIZIONI CONTRATTUALI.', 15, finalY);
                
                finalY += 4;
                doc.text('LA SOTTOSCRIZIONE DEL PRESENTE VERBALE COSTITUISCE TITOLO VALIDO AL FINE DELLA DECORRENZA DEGLI ADEMPIMENTI', 15, finalY);
                finalY += 3;
                doc.text('CONTRATTUALI LEGATI AL COLLAUDO.', 15, finalY);

                // Allegati
                finalY += 8;
                doc.setFont(undefined, 'bold');
                doc.text('ALLEGATI:', 15, finalY);
                
                doc.rect(35, finalY - 3, 3, 3);
                doc.text('X', 36, finalY - 0.5);
                doc.setFont(undefined, 'normal');
                doc.text('DICHIARAZIONE DI CONFORMITA\'', 40, finalY);
                
                doc.rect(110, finalY - 3, 3, 3);
                doc.text('SCHEDA MISURE', 115, finalY);
                
                finalY += 5;
                doc.rect(35, finalY - 3, 3, 3);
                doc.text('ALTRE:', 40, finalY);

                // Data verbale e firme
                finalY += 8;
                doc.setFont(undefined, 'bold');
                doc.text('Data verbale:', 15, finalY);
                doc.setFontSize(6);
                doc.setFont(undefined, 'italic');
                doc.text('(ACCEPTANCE DATE)', 15, finalY + 3);
                
                doc.setFontSize(7);
                doc.setFont(undefined, 'normal');
                doc.rect(15, finalY + 5, 80, 20);
                
                doc.text('Per la Casa fornitrice', 15, finalY + 8);
                doc.setFontSize(6);
                doc.setFont(undefined, 'italic');
                doc.text('(SUPPLIER)', 15, finalY + 11);
                
                doc.setFontSize(7);
                doc.setFont(undefined, 'normal');
                doc.rect(110, finalY + 5, 85, 20);
                doc.text('Timbro e firma del Cliente', 110, finalY + 8);
                doc.setFontSize(6);
                doc.setFont(undefined, 'italic');
                doc.text('(CUSTOMER)', 110, finalY + 11);

                // Sezione Garanzia (solo per training: "Se applicabile")
                finalY += 28;
                doc.setFontSize(7);
                doc.setFont(undefined, 'normal');
                doc.text('Se applicabile:', 15, finalY);
                finalY += 4;
                doc.text('Per le parti meccaniche ed elettriche, mesi', 15, finalY);
                finalY += 4;
                doc.text('a scalare', 15, finalY);

                // Footer aziendale
                finalY += 10;
                doc.setFontSize(6);
                doc.setFont(undefined, 'bold');
                doc.text('GE Medical Systems Italia S.p.A.', 15, finalY);
                finalY += 3;
                doc.setFont(undefined, 'normal');
                doc.text('SocietÃ  con socio unico, Capitale â‚¬ 5.000.000 i.v. - Sede Legale: Via Galeno 36, 20126 Milano', 15, finalY);
                finalY += 3;
                doc.text('CF e Registro Imprese Milano 93027710016 REA 1689710 P.IVA 03663500969', 15, finalY);
                finalY += 3;
                doc.text('SocietÃ  soggetta a controllo e coordinamento di General Electric Company', 15, finalY);
                finalY += 3;
                doc.text('TEL +39 02 26001111 - FAX +39 02 26001413', 15, finalY);

                doc.save(`Training_${trainingData.gonNr || 'documento'}.pdf`);
                setStatusMessage({ type: 'success', text: 'PDF Training esportato con successo!' });
            };

            return (
                <div className="app-container">
                    <div className="header">
                        <img 
                            src="https://images.seeklogo.com/logo-png/46/2/ge-healthcare-2023-logo-png_seeklogo-465260.png" 
                            alt="GE Healthcare"
                            style={{ height: '120px' }}
                        />
                        <div style={{ marginLeft: 'auto', color: '#666', fontSize: '14px', textAlign: 'right' }}>
                            <p>Generatore Moduli Collaudo e Training</p>
                        </div>
                    </div>

                    <div className="upload-section">
                        <h2 style={{ color: '#522398', marginBottom: '20px' }}>1. Carica Pick (PDF)</h2>
                        <div 
                            className="upload-area"
                            onClick={() => fileInputRef.current.click()}
                            onDragOver={handleDragOver}
                            onDragLeave={handleDragLeave}
                            onDrop={handleDrop}
                        >
                            <div className="upload-icon">ðŸ“„</div>
                            <div className="upload-text">
                                {pickData ? 'âœ“ PDF caricato con successo' : 'Clicca per caricare o trascina qui il PDF della Pick'}
                            </div>
                            <div className="upload-hint">
                                {pickData ? `${pickData.items.length} articoli trovati` : 'Formato supportato: PDF'}
                            </div>
                        </div>
                        <input 
                            type="file" 
                            ref={fileInputRef}
                            className="file-input"
                            accept=".pdf"
                            onChange={handleFileUpload}
                        />
                    </div>

                    {statusMessage && (
                        <div className={`status-message ${statusMessage.type}`}>
                            {statusMessage.text}
                        </div>
                    )}

                    {isLoading && (
                        <div className="loading">
                            <p>Caricamento in corso...</p>
                        </div>
                    )}

                    {pickData && (
                        <div className="tabs-container">
                            <div className="tabs-header">
                                <button 
                                    className={`tab ${activeTab === 'collaudo' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('collaudo')}
                                >
                                    ðŸ“‹ Modulo Collaudo
                                </button>
                                <button 
                                    className={`tab ${activeTab === 'training' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('training')}
                                >
                                    ðŸŽ“ Modulo Training
                                </button>
                            </div>

                            <div className="tab-content">
                                {activeTab === 'collaudo' ? (
                                    <>
                                        <h2 style={{ color: '#522398', marginBottom: '20px' }}>
                                            2. Compila Modulo Collaudo
                                        </h2>
                                        
                                        <div className="form-grid">
                                            <div className="form-group">
                                                <label>Intestatario (Bill To)</label>
                                                <textarea
                                                    value={collaudoData.billTo}
                                                    onChange={(e) => updateCollaudoField('billTo', e.target.value)}
                                                    placeholder="Inserisci intestatario"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>Destinazione (Ship To)</label>
                                                <textarea
                                                    value={collaudoData.shipTo}
                                                    onChange={(e) => updateCollaudoField('shipTo', e.target.value)}
                                                    placeholder="Inserisci destinazione"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>CIG nr</label>
                                                <input
                                                    type="text"
                                                    value={collaudoData.cigNr}
                                                    onChange={(e) => updateCollaudoField('cigNr', e.target.value)}
                                                    placeholder="Inserisci CIG"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>System in Must nr</label>
                                                <input
                                                    type="text"
                                                    value={collaudoData.systemMust}
                                                    onChange={(e) => updateCollaudoField('systemMust', e.target.value)}
                                                    placeholder="Inserisci System in Must"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>Ordine Cliente (PO nr)</label>
                                                <input
                                                    type="text"
                                                    value={collaudoData.poNr}
                                                    onChange={(e) => updateCollaudoField('poNr', e.target.value)}
                                                    placeholder="Inserisci PO"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>GON nr</label>
                                                <input
                                                    type="text"
                                                    value={collaudoData.gonNr}
                                                    onChange={(e) => updateCollaudoField('gonNr', e.target.value)}
                                                    placeholder="Inserisci GON"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>CUP nr</label>
                                                <input
                                                    type="text"
                                                    value={collaudoData.cupNr}
                                                    onChange={(e) => updateCollaudoField('cupNr', e.target.value)}
                                                    placeholder="Inserisci CUP"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>Durata Garanzia (mesi)</label>
                                                <input
                                                    type="text"
                                                    value={collaudoData.warrantyPeriod}
                                                    onChange={(e) => updateCollaudoField('warrantyPeriod', e.target.value)}
                                                    placeholder="Inserisci durata garanzia"
                                                />
                                            </div>
                                        </div>
                                        
                                        <div className="form-group" style={{ marginBottom: '30px' }}>
                                            <label>Testo Garanzia (opzionale - verrÃ  inserito nel riquadro WARRANTY PERIOD)</label>
                                            <textarea
                                                value={collaudoData.warrantyText}
                                                onChange={(e) => updateCollaudoField('warrantyText', e.target.value)}
                                                placeholder="Es: Per le parti meccaniche ed elettriche, 12 mesi a scalare"
                                                style={{ minHeight: '80px' }}
                                            />
                                        </div>

                                        <div className="items-section">
                                            <div className="items-header">
                                                <h3>Articoli</h3>
                                                <button className="add-item-btn" onClick={addCollaudoItem}>
                                                    + Aggiungi Articolo
                                                </button>
                                            </div>
                                            
                                            {collaudoData.items.length > 0 ? (
                                                <div className="items-table">
                                                    <table>
                                                        <thead>
                                                            <tr>
                                                                <th>Item Number</th>
                                                                <th>Description</th>
                                                                <th>Qty</th>
                                                                <th>Serial Number</th>
                                                                <th>Azioni</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {collaudoData.items.map((item, index) => (
                                                                <tr key={index}>
                                                                    <td>
                                                                        <input
                                                                            type="text"
                                                                            value={item.itemNumber}
                                                                            onChange={(e) => updateCollaudoItem(index, 'itemNumber', e.target.value)}
                                                                        />
                                                                    </td>
                                                                    <td>
                                                                        <input
                                                                            type="text"
                                                                            value={item.description}
                                                                            onChange={(e) => updateCollaudoItem(index, 'description', e.target.value)}
                                                                        />
                                                                    </td>
                                                                    <td>
                                                                        <input
                                                                            type="text"
                                                                            value={item.qty}
                                                                            onChange={(e) => updateCollaudoItem(index, 'qty', e.target.value)}
                                                                        />
                                                                    </td>
                                                                    <td>
                                                                        <input
                                                                            type="text"
                                                                            value={item.serialNumber}
                                                                            onChange={(e) => updateCollaudoItem(index, 'serialNumber', e.target.value)}
                                                                        />
                                                                    </td>
                                                                    <td>
                                                                        <button 
                                                                            className="delete-btn"
                                                                            onClick={() => deleteCollaudoItem(index)}
                                                                        >
                                                                            Elimina
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            ) : (
                                                <div className="empty-state">
                                                    <div className="empty-state-icon">ðŸ“¦</div>
                                                    <p>Nessun articolo presente</p>
                                                </div>
                                            )}
                                        </div>

                                        <div className="export-section">
                                            <button 
                                                className="export-btn"
                                                onClick={exportCollaudoPDF}
                                                disabled={collaudoData.items.length === 0}
                                            >
                                                ðŸ“¥ Esporta PDF Collaudo
                                            </button>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <h2 style={{ color: '#522398', marginBottom: '20px' }}>
                                            2. Compila Modulo Training
                                        </h2>
                                        
                                        <div className="form-grid">
                                            <div className="form-group">
                                                <label>Intestatario (Bill To)</label>
                                                <textarea
                                                    value={trainingData.billTo}
                                                    onChange={(e) => updateTrainingField('billTo', e.target.value)}
                                                    placeholder="Inserisci intestatario"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>Destinazione (Ship To)</label>
                                                <textarea
                                                    value={trainingData.shipTo}
                                                    onChange={(e) => updateTrainingField('shipTo', e.target.value)}
                                                    placeholder="Inserisci destinazione"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>CIG nr</label>
                                                <input
                                                    type="text"
                                                    value={trainingData.cigNr}
                                                    onChange={(e) => updateTrainingField('cigNr', e.target.value)}
                                                    placeholder="Inserisci CIG"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>System in Must nr</label>
                                                <input
                                                    type="text"
                                                    value={trainingData.systemMust}
                                                    onChange={(e) => updateTrainingField('systemMust', e.target.value)}
                                                    placeholder="Inserisci System in Must"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>Ordine Cliente (PO nr)</label>
                                                <input
                                                    type="text"
                                                    value={trainingData.poNr}
                                                    onChange={(e) => updateTrainingField('poNr', e.target.value)}
                                                    placeholder="Inserisci PO"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>GON nr</label>
                                                <input
                                                    type="text"
                                                    value={trainingData.gonNr}
                                                    onChange={(e) => updateTrainingField('gonNr', e.target.value)}
                                                    placeholder="Inserisci GON"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>CUP nr</label>
                                                <input
                                                    type="text"
                                                    value={trainingData.cupNr}
                                                    onChange={(e) => updateTrainingField('cupNr', e.target.value)}
                                                    placeholder="Inserisci CUP"
                                                />
                                            </div>
                                        </div>

                                        <div className="items-section">
                                            <div className="items-header">
                                                <h3>Articoli</h3>
                                                <button className="add-item-btn" onClick={addTrainingItem}>
                                                    + Aggiungi Articolo
                                                </button>
                                            </div>
                                            
                                            {trainingData.items.length > 0 ? (
                                                <div className="items-table">
                                                    <table>
                                                        <thead>
                                                            <tr>
                                                                <th>Item Number</th>
                                                                <th>Description</th>
                                                                <th>Qty</th>
                                                                <th>Serial Number</th>
                                                                <th>Azioni</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {trainingData.items.map((item, index) => (
                                                                <tr key={index}>
                                                                    <td>
                                                                        <input
                                                                            type="text"
                                                                            value={item.itemNumber}
                                                                            onChange={(e) => updateTrainingItem(index, 'itemNumber', e.target.value)}
                                                                        />
                                                                    </td>
                                                                    <td>
                                                                        <input
                                                                            type="text"
                                                                            value={item.description}
                                                                            onChange={(e) => updateTrainingItem(index, 'description', e.target.value)}
                                                                        />
                                                                    </td>
                                                                    <td>
                                                                        <input
                                                                            type="text"
                                                                            value={item.qty}
                                                                            onChange={(e) => updateTrainingItem(index, 'qty', e.target.value)}
                                                                        />
                                                                    </td>
                                                                    <td>
                                                                        <input
                                                                            type="text"
                                                                            value={item.serialNumber}
                                                                            onChange={(e) => updateTrainingItem(index, 'serialNumber', e.target.value)}
                                                                        />
                                                                    </td>
                                                                    <td>
                                                                        <button 
                                                                            className="delete-btn"
                                                                            onClick={() => deleteTrainingItem(index)}
                                                                        >
                                                                            Elimina
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            ) : (
                                                <div className="empty-state">
                                                    <div className="empty-state-icon">ðŸ“¦</div>
                                                    <p>Nessun articolo presente</p>
                                                </div>
                                            )}
                                        </div>

                                        <div className="export-section">
                                            <button 
                                                className="export-btn"
                                                onClick={exportTrainingPDF}
                                                disabled={trainingData.items.length === 0}
                                            >
                                                ðŸ“¥ Esporta PDF Training
                                            </button>
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
